<doctype html="">
<title>Open Microfluidics Station</title>
<!--meta http-equiv="refresh" content="2" /-->
<h2>Open Microfluidics Station</h2>

<script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
<!--<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>-->
<script type="text/javascript" charset="utf-8">
//  var socket = io.connect('http://' + document.domain + ':' + location.port);
  var socket = io();
  var strobe = {{strobe|tojson}}
  var heaters = {{heaters|tojson}}
  
  function strobe_update_init()
  {
    $('#input_strobe_period_us').val( strobe.period_ns / 1000 );
    $('#input_strobe_wait_us').val( strobe.wait_ns / 1000 );
  }
  
  function strobe_update()
  {
    $('#strobe_enable').html( strobe.enable ? 'Enabled' : 'Disabled' );
    $('#btn_strobe_enable').html( strobe.enable ? 'Disable' : 'Enable' );
    
    $('#strobe_hold').html( strobe.hold ? 'On' : 'Off' );
    $('#btn_strobe_hold').html( strobe.hold ? 'Hold Off' : 'Hold On' );
    
    $('#strobe_period_us').html( strobe.period_ns / 1000 );
    $('#strobe_wait_us').html( strobe.wait_ns / 1000 );
    $('#strobe_cam_time_us').html( strobe.cam_read_time_us );
  }
  
  function heaters_update_init()
  {
    for ( var i=0; i<=3; i++ )
    {
      $('#input_heater'+(i+1)+'_temp_c_target').val( heaters[i].temp_c_target.toString() );
    }
  }
  
  function heaters_update()
  {
    for ( var i=0; i<=3; i++ )
    {
      $('#heater'+(i+1)+'_status').html( heaters[i].status );
      $('#heater'+(i+1)+'_temp_text').html( heaters[i].temp_text );
    }
  }
  
  $(document).ready(function() {
    strobe_update_init();
    heaters_update_init();
    strobe_update();
    heaters_update();
    
    socket.on( 'connect', function() {
      console.log( 'Websocket connected!' );
    });
    socket.on('disconnect', function(){
      console.log( 'Websocket connection lost!' );
    });
    socket.on( 'debug', function( data ) {
      $('#update_count').html( data.update_count );
    });
    socket.on( 'heaters', function( data ) {
      heaters = data;
      heaters_update();
    });
    socket.on( 'strobe', function( data ) {
      strobe = data;
      strobe_update();
    });
  });
  
  function strobe_enable() {
    socket.emit( 'strobe', { cmd: 'enable', parameters: { 'on': strobe.enable ? 0 : 1 } } );
  }
  function strobe_hold() {
    socket.emit( 'strobe', { cmd: 'hold', parameters: { 'on': strobe.hold ? 0 : 1 } } );
  }
  function strobe_wait() {
//    socket.emit( 'strobe', { cmd: 'timing', parameters: { 'wait_ns': ( 10000 ), 'period_ns': strobe.period_ns } } );
    socket.emit( 'strobe', { cmd: 'timing', parameters: { 'wait_ns': ( $('#input_strobe_wait_us').val() * 1000 ), 'period_ns': strobe.period_ns } } );
  }
  function strobe_period() {
    socket.emit( 'strobe', { cmd: 'timing', parameters: { 'wait_ns': strobe.wait_ns, 'period_ns': ( $('#input_strobe_period_us').val() * 1000 ) } } );
  }
  function heater_temp_c_target( index ) {
    socket.emit( 'heater', { cmd: 'temp_c_target', parameters: { 'index': index, 'temp_c_target': ( $('#input_heater'+index+'_temp_c_target').val() ) } } );
  }
</script>

<p></p><p>
{% with messages = get_flashed_messages() %}
  {% if messages %}
    </p><ul class="flashes">
    {% for message in messages %}
      <li>{{ message }}</li>
    {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<p>Update Count: <a id='update_count'>{{debug.update_count}}</a></p>

<h3>Strobe</h3>
<table style="border: 1px solid black; padding: 10px" cellpadding="2px">
  <tr>
    <td width=150>Enabled</td>
    <td width=100><p id='strobe_enable'></p></td>
    <td></td>
    <td><button id='btn_strobe_enable', onclick="strobe_enable()", style="width: 100px"></button></td>
  </tr>
  <tr>
    <td>Hold</td>
    <td><p id='strobe_hold'></p></td>
    <td></td>
    <td><button id='btn_strobe_hold', onclick="strobe_hold()", style="width: 100px"></button></td>
  </tr>
  <tr>
    <td>Wait (us)</td>
    <td><p id='strobe_wait_us'></p></td>
    <td><input type="number" id="input_strobe_wait_us" min="0" max="10000"></td>
    <td><button id='btn_strobe_wait_us', onclick="strobe_wait()", style="width: 100px">Set</button></td>
  </tr>
  <tr>
    <td>Period (us)</td>
    <td><p id='strobe_period_us'></p></td>
    <td><input type="number" id="input_strobe_period_us" min="1" max="10000"></td>
    <td><button id='btn_strobe_period_us', onclick="strobe_period()", style="width: 100px">Set</button></td>
  </tr>
  <tr>
    <td>Cam Read Time (us)</td>
    <td><p id='strobe_cam_time_us'></p></td>
    <td></td>
    <td></td>
  </tr>
</table>

{% for heater in heaters %}
  <h3>Heater {{loop.index}}</h3>
  <table style="border: 1px solid black; padding: 10px" cellpadding="2px">
    <tr>
      <td width=150>Status</td>
      <td width=100><p id='heater{{loop.index}}_status'></p></td>
    </tr>
    <tr>
      <td>Temperature (degC)</td>
      <td><p id='heater{{loop.index}}_temp_text'></p></td>
      <td><input type="number" id="input_heater{{loop.index}}_temp_c_target" min="-50" max="100"></td>
      <td><button id='btn_heater{{loop.index}}_temp_c_target', onclick="heater_temp_c_target({{loop.index}})", style="width: 100px">Set</button></td>
    </tr>
  </table>
{% endfor %}

</doctype>